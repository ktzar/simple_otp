<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UW 2FA Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/otpauth/9.1.2/otpauth.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
    <style>#display-area{text-align: center}</style>
</head>
<body>

<main class="container">
    <h2>UW 2FA Generator</h2>
    <input type="text" id="label" placeholder="Account Name (e.g. Github)">
    <input type="password" id="secret" placeholder="Secret Key (Base32)">
    <button onclick="saveSecret()">Save &amp; Generate</button>

    <div id="display-area" style="display:none;">
        <hr/>
        <h4 id="account-label"></h4>
        <article><h5 class="grid" id="token">000 000</h5></article>
        <div class="timer"><progress min="0" max="30" id="progress" class="progress"/></div>
    </div>
</main>

<script>
    let totp = null;
    const $ = (id ) => document.getElementById(id);

    // Load from localStorage on startup
    window.onload = () => {
        const savedSecret = localStorage.getItem('2fa_secret');
        const savedLabel = localStorage.getItem('2fa_label');
        if (savedSecret) {
            $('secret').value = savedSecret;
            $('label').value = savedLabel;
            initTOTP(savedSecret, savedLabel);
        }
    };

    function saveSecret() {
        const secret = $('secret').value.replace(/\s+/g, '').toUpperCase();
        const label = $('label').value;
        
        localStorage.setItem('2fa_secret', secret);
        localStorage.setItem('2fa_label', label);
        initTOTP(secret, label);
    }

    function initTOTP(secret, label) {
        try {
            totp = new OTPAuth.TOTP({
                issuer: 'Some org',
                label: label,
                algorithm: 'SHA1',
                digits: 6,
                period: 30,
                secret: secret
            });
            $('display-area').style.display = 'block';
            updateToken();
        } catch (e) {
            alert("Invalid Secret Key format (Base32 required)");
        }
    }

    function updateToken() {
        if (!totp) return;
        
        const token = totp.generate();
        $('token').innerText = token.slice(0,3) + ' ' + token.slice(3);
        $('account-label').innerText = localStorage.getItem('2fa_label');
        
        const seconds = Date.now() / 1000 % 30;
        $('progress').value = 30-seconds;
    }

    // Refresh every 100ms
    setInterval(updateToken, 100);
</script>

</body>
</html>
